<script>

    (function(){
        var component_ID = {
            type: "tab",
            demo: false,
            version: 2.1,
            kind: "component",
            name: "insert.html",
            path: "/texture-tab/insert.html",
            description: "inserts new texture in zangoDB.",
        };
    })();

</script>

<style>

    .helpers-header h2 { 
        cursor:pointer; 
    }

    .texture-checkbox {
        width:34px;
    }

    #texture-property-controls {
        background:none;
        border-radius:8px;
        height:73px;
    }

</style>

<div class="helpers-header texture-header">
    <h2 style="margin-bottom:20px;">Texture:</h2>
</div>

<div id="texture-viewer" style="text-align:center;margin-bottom:10px;border:1px solid;">
    <img id="texture-preview" style="max-width:100%;max-height:300px;margin:auto;">
</div>

<div style="height:45px;margin-bottom:10px;">
    <select id="imported-textures" class="form-control material-texture-droplist" readonly>
        <option value="">Select imported texture:</option>
    </select>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select gender:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="texture-gender-droplist" class="form-control gender-droplist" readonly>
                <option value="">Select sex:</option>
                <option value="male">male</option>
                <option value="female">female</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const titleTextfield = $("input#material-title").get(0);
    const slotDroplist   = $("#texture-outfit-slot").get(0);
    const genderDroplist = $("#texture-gender-droplist").get(0);
    const texturePreview = $("img#texture-preview").get(0);
    const importedTextures = $("select#imported-textures").get(0);

    var Signal = signals.Signal;
    var genderChanged = new Signal();

    $(genderDroplist).on("change", function(){

        if ( !this.value ) {

        //  Overwrite gender value.
            this.value = viewer.contentWindow.localPlayer.outfit.getGender();

        }

        if ( !this.value ) {

        //  Reset texture preview.
        // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".

            $(texturePreview).attr({src: "//:0"}); 

            return;  //  Null values NOT allowed.

        }

        genderChanged.dispatch( this.value );

    });

    genderChanged.add(function(value){

        if ( !value ) {

        //  Reset texture preview.
        // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".

            $(texturePreview).attr({src: "//:0"}); 

            return;  //  Null values NOT allowed.

        };

        var data = "/gender/" + value;
        viewer.contentWindow.localPlayerHandler(data);

        store( "Sex", data );

    });

    genderChanged.add(function(){

        if ( !slotDroplist.value ) return;
        if ( !genderDroplist.value ) return;
        if ( importedTextures.value ) return;

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

        if ( !viewer.contentWindow[gender][slot] ) {

        //  Reset texture preview.
        // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".

            $(texturePreview).attr({src: "//:0"}); 

            return;  //  Null outfit NOT allowed.

        };

        var THREE = viewer.contentWindow.THREE; // important!
        var geometry = viewer.contentWindow[gender][slot].geometry;
        texturePreview.src = THREE.UVsDebug(geometry, 512).toDataURL();

    });

})();

</script>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select outfit slot:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="texture-outfit-slot" class="form-control outfit-slot-droplist" readonly>
                <option value="">Select slot:</option>
                <option value="body">body</option>
                <option value="eyes">eyes</option>
                <option value="hairs">hairs</option>
                <option value="stockings">stockings</option>
                <option value="underwears">underwears</option>
                <option value="costume">costume</option>
                <option value="tshirt">tshirt</option>
                <option value="trousers">trousers</option>
                <option value="dress">dress</option>
                <option value="shoes">shoes</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const slotDroplist   = $("#texture-outfit-slot").get(0);
    const genderDroplist = $("#texture-gender-droplist").get(0);
    const texturePreview = $("img#texture-preview").get(0);
    const importedTextures = $("select#imported-textures").get(0);

    var Signal = signals.Signal;
    var outfitSlotChanged = new Signal();

    $(slotDroplist).on("change", function(){

        if ( !this.value ) {

        //  Reset texture preview.
        //  https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src

            $(texturePreview).attr({src: "//:0"}); 

        }

    //  Null value IS allowed!

        outfitSlotChanged.dispatch(this.value);

    });

    outfitSlotChanged.add(function(value){

        if ( !value ) {

        //  Reset texture preview.
        // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".

            $(texturePreview).attr({src: "//:0"}); 

        };

    //  Null value IS allowed!

        var data = "/select/" + value;
        viewer.contentWindow.localPlayerHandler(data);

    });

    outfitSlotChanged.add(function(){

        if ( !slotDroplist.value ) return;
        if ( !genderDroplist.value ) return;
        if ( importedTextures.value ) return;

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

        if ( !viewer.contentWindow[gender][slot] ) {

        //  Reset texture preview.
        // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".

            $(texturePreview).attr({src: "//:0"}); 

            return;  //  Null outfit NOT allowed.

        };

        var THREE = viewer.contentWindow.THREE; // important!
        var geometry = viewer.contentWindow[gender][slot].geometry;
        texturePreview.src = THREE.UVsDebug(geometry, 512).toDataURL();

    });

})();

</script>

<div id="texture-property-controls" class="well"></div>

<div id="texture-map-controls" class="well" style="background:none;border-radius:8px;height:auto;display:none;">

    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">Map:</span>
        <input type="checkbox" id="map" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">BumpMap:</span>
        <input type="checkbox" id="bumpMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">EmissiveMap:</span>
        <input type="checkbox" id="emissiveMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">MetalnessMap:</span>
        <input type="checkbox" id="metalnessMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">RoughnessMap:</span>
        <input type="checkbox" id="roughnessMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">DisplacementMap:</span>
        <input type="checkbox" id="displacementMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">AOMap:</span>
        <input type="checkbox" id="aoMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">AlphaMap:</span>
        <input type="checkbox" id="alphaMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">LightMap:</span>
        <input type="checkbox" id="lightMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">NormalMap:</span>
        <input type="checkbox" id="normalMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>

</div>

<div style="margin-bottom:20px;">
    <input id="texture-fileinput" type="file" class="hidden" multiple>
    <div id="clear-imported-textures" class="form-control btn btn-danger btn-white-outline gradient-btn pull-left" style="width:24%;">Clear</div>
    <div id="import-texture-button" class="form-control btn btn-primary btn-white-outline gradient-btn" style="width:24%;margin:0 1%;">Import</div>
    <div id="upload-selected-texture" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:24%;">Upload</div>
    <div id="delete-selected-texture" class="form-control btn btn-danger btn-white-outline gradient-btn pull-right" style="width:24%;">Delete</div>
</div>

<hr/>

<script>

(function(){

    const textureHeaderSelector = ".texture-header";
    const helpersHeaderSelector = ".helpers-header";
    const textureControlSelector = "#texture-map-controls";

    var Signal = signals.Signal;
    var dblclicked = new Signal();

//  Event handlers.
    function onDoubleClickEventHandler( element ){
        if ( $(element).css("display") == "none" ) {
            $(element).slideDown();
        } else {
            $(element).slideUp();
        }
    }

//  Event listeners.
    dblclicked.add(onDoubleClickEventHandler);

//  Dispatch events.
    $(textureHeaderSelector).on("dblclick", function(){
        dblclicked.dispatch( $(textureControlSelector).get(0) );
    });

})();

</script>

<script>

(function(){

/*
//  const VERSION = 4;
    const NAME = "USER";

    var db = new zango.Db( NAME, {
        animations: true,
        outfits:    true,
        materials:  true,
        textures:   true,
        products:   true,
    });

    db.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`Database ${db.name} (v${db.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });
*/

    const files = {};
    const uploads = [];
    const textures = {};

    const viewer = document.getElementById("viewer");
    const slotDroplist     = $("#texture-outfit-slot").get(0);
    const genderDroplist   = $("#texture-gender-droplist").get(0);
    const textureControls  = $("#texture-map-controls").get(0);
    const textureImportBtn = $("#import-texture-button").get(0);
    const textureFileinput = $("input#texture-fileinput").get(0);
    const textureDeleteBtn = $("#delete-selected-texture").get(0);
    const texturesClearBtn = $("#clear-imported-textures").get(0);
    const textureUploadBtn = $("#upload-selected-texture").get(0);
    const textureDroplist  = $("select#imported-textures").get(0);
    const texturePreviewImg = $("img#texture-preview").get(0);

//  const THREE = viewer.contentWindow.THREE;

    const textureControlSelector = "#texture-map-controls";
    const textureCheckboxSelector = "input[type=checkbox].material-texture-checkbox";
    const texturePropertyControls = document.getElementById("texture-property-controls");

    var Signal = signals.Signal;
    var textureDroplistChanged = new Signal();

    const generateUUID = function (){
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
        .replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0;
            var v = c == 'x'?r:r&0x3|0x8;
            return v.toString(16);
        }).toLocaleUpperCase();
    }

    const jsonTexture = function () {
        return {
            anisotropy: 1,
            encoding: 3000,
            flipY: true,
            format: 1021,
            generateMipmaps: true,
            magFilter: 1006,
            mapping: 300,
            minFilter: 1008,
            mipmaps: [],
            name: "",
            offset: [0, 0],
            premultiplyAlpha: false,
            repeat: [1, 1],
            sourceFile: "",
            type: 1009,
            unpackAlignment: 4,
            uuid: generateUUID(),
            version: 0,
            wrapS: 1001,
            wrapT: 1001,
            _id: ObjectId(),
        };
    }

    const maps = [
        "map", 
        "bumpMap", 
        "emissiveMap", 
        "metalnessMap", 
        "roughnessMap", 
        "displacementMap", 
        "alphaMap", 
        "normalMap", 
        "lightMap", 
    //  "envMap",
        "aoMap", 
    ];

    maps.forEach(function( key ){
        $(textureControls).find(`input#${key}`).on("click", function(){

            if (!textureDroplist.value) return;

            var name = textureDroplist.value;

            if ( !this.checked ) {

                var texture = null;
                delete json[ key ];

            } else {

                var texture = textures[ name ];  //  json texture.
                json[ key ] = textures[ name ];

            }

            propertyValueChanged.dispatch( key, texture );

        });
    });

//  BUTTON IMPORT.

    $(textureImportBtn).on("click", function(){
        $(textureFileinput).val("");
        $(textureFileinput).click();
    });

    $(textureFileinput).on("change", function(){
        if ( this.files.length == 0 ) return;

        $(textureCheckboxSelector).attr({checked:false});

        for (var i = 0; i < this.files.length; i++ ) {

            (function(){

                var file = textureFileinput.files[i];
                var name = textureFileinput.files[i].name;

                if ( name in files && file.lastModified == files[name].lastModified 
                    && file.size == files[name].size && file.type == files[name].type ) {

                        // (WHATEVER) //

                } else {

                    files[ name ] = file;

                    var reader = new FileReader();
                    reader.onload = function() {

                        textures[ name ] = new jsonTexture();
                        textures[ name ].sourceFile = reader.result;
                        textures[ name ].name = name;

                        var option = document.createElement("option");
                        option.value = option.innerText = name;
                        option.id = textures[ name ]._id;

                        $(textureDroplist).append(option);
                        //  textureDroplist.value = name;

                    };

                    reader.readAsDataURL(files[ name ]);

                }

            })();

        }

        debugMode && console.log({
            "files": files, 
            "textures": textures,
        });

    });


//  SELECT TEXTURE DROPLIST.

    textureDroplistChanged.add(function(){


    });

    $(textureDroplist).on("change", function(){

        $(textureCheckboxSelector).attr({checked:false});

        if ( this.value ) {

            var src = textures[ this.value ].sourceFile;
            $(texturePreviewImg).attr({"src":src});

        } else {

            (function(){

                if ( !slotDroplist.value ) return;
                if ( !genderDroplist.value ) return;

                var slot = slotDroplist.value;
                var gender = genderDroplist.value;

                if ( !viewer.contentWindow[gender][slot] ) return;

                var THREE = viewer.contentWindow.THREE; // important!
                var geometry = viewer.contentWindow[gender][slot].geometry;
                texturePreviewImg.src = THREE.UVsDebug(geometry, 512).toDataURL();

            })();

        }

        if ( !this.value ) {
            $(textureControlSelector).slideUp();
        } else {
            $(textureControlSelector).slideDown();
        }

    });


//  BUTTON DELETE.

    $(textureDeleteBtn).on("click", function(){
        var option = textureDroplist.selectedOptions[0];

        if ( !option ) return;
        if ( !option.value ) return;

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){

            $(option).remove();

            $(textureControlSelector).slideUp();
            $(textureCheckboxSelector).attr({checked:false});
            $(textureDroplist).change(); // or ...dispatch();

        //  Optional.

            delete files[ option.value ];
            delete textures[ option.value ];
            debugMode && console.log({"files":files, "textures": textures});

        }, 250 );

    });


//  BUTTON CLEAR.

    $(texturesClearBtn).on("click", function(){

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){
            debugMode && console.log({"files":files, "textures": textures});

            $(textureDroplist).children().remove();
            var option = document.createElement("option");
            option.value = "";  option.innerText = "Select imported texture:";
            $(textureDroplist).append(option);

            $(textureControlSelector).slideUp();
            $(textureCheckboxSelector).attr({checked:false});

        //  Optional.

            for (var name in textures){
                delete files[name];
                delete textures[name];
            }

            files = {}; textures = {};

        }, 250 );

    });


//  BUTTON UPLOAD.

    $(textureUploadBtn).on("click", function(){
        debugMode && console.log({"uploads":uploads});

        if ( !uploads.length ) {
            var msg = "There is nothing to upload.";
            return bootbox.dialog({
                size: "small",
                className: "middle",
                title: `<div class="alert-icon icon-warning"></div>`
                     + `<h2 style="margin:auto;">Sorry!</h2>`,
                message: `<div>${msg}</div>`,
                buttons: {
                    cancel: {
                        label: "Close",
                        className: "btn-default",
                        callback: function(){
                            debugMode && console.log(msg);
                        },
                    },
                },
            });
        }

        if ( !navigator.onLine ) {
            var msg = "Your connection to the internet is down.";
            return bootbox.dialog({
                size: "small",
                className: "middle",
                title: `<div class="alert-icon icon-error"></div>`
                     + `<h2 style="margin:auto;">Sorry!</h2>`,
                message: `<div>${msg}</div>`,
                buttons: {
                    cancel: {
                        label: "Close",
                        className: "btn-default",
                        callback: function(){
                            debugMode && console.log(msg);
                        },
                    },
                },
            });
        }

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){

            while( uploads.length ){
                uploads.shift().call();
            }

        }, 250 );

    });

//  deepCopy.js

    function deepCopy(obj) {
        if (Object.prototype.toString.call(obj) === "[object Array]") {
            var out = [], i = 0, len = obj.length;
            for ( ; i < len; i++ ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        if (typeof obj === "object") {
            var out = {}, i;
            for ( i in obj ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        return obj;
    }

//  round.js  source: "https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round"

    function round(number, precision) {
        var shift = function (number, precision, reverseShift) {
            if (reverseShift) {
                precision = -precision;
            }  
            numArray = ("" + number).split("e");
            return +(numArray[0] + "e" + (numArray[1] ? (+numArray[1] + precision) : precision));
        };
        return shift(Math.round(shift(number, precision, false)), precision, true);
    }

})();

</script>
