<script>

    (function(){
        var component_ID = {
            type: "tab",
            beta: true,
            version: 2.3,
            kind: "component",
            name: "insert.html",
            path: "/texture-tab/insert.html",
            description: "inserts new texture in zangoDB.",
        };
    })();

</script>

<style>

    .helpers-header h2 { 
        cursor:pointer; 
    }

    .texture-checkbox {
        width:34px;
    }

    .texture-value {
        text-align: center;
        font-size: x-large;
        font-weight: bold;
    }

    .x-large {
        font-size: x-large;
    }
    
    .texture-property-controls {
        height:72px;
    }

    .uuid-texture-textfield {
        width:80%;
    }

    .texture-textfield {
        width:75%;
        float:right;
    }

    .texture-checkbox {
        width:34px;
    }

    .texture-checkbox-helper {
        height:40px;
        margin-top:0px;
        margin-bottom:0px;
    }

    .texture-input-number {
        width: 60px;
        padding: 0;
        text-align: right;
        background: none;
        font-weight: bold;
        font-size: 18px;
        border: none;
        color: #ffff;
    }

    #texture-property-controls {
        background:none;
        border-radius:8px;
        height:73px;
    }

/*  texture pager  */

    .helpers-header h3 { cursor:pointer; }

    .texture-item {
        padding: 4px 15px;
        text-align: left;
        vertical-align: middle;
        cursor: pointer;
    }

    .selected {
        color:#fff;
        background-color:#73b8f3;
    }

    #texture-items {
        max-width:475px;
    /*  max-height:710px; */
        color:#fff;
        border:none;
        padding:0px;
        background-color:#fff0;
    }

    #documents-display {
        height:170px;
        overflow:auto;
        background:none;
        border-radius:8px;
    }

    .page-btn {
        max-width:45px;
        padding:6px 10px;
    }

/*  meter.css (loading bar)  */

    .meter { 

        height: 20px;  /* Can be anything */
        position: relative;
        background: #555;
        -moz-border-radius: 25px;
        -webkit-border-radius: 25px;
        border-radius: 25px;
        -webkit-box-shadow: inset 0 -1px 1px rgba(255,255,255,0.3);
        -moz-box-shadow   : inset 0 -1px 1px rgba(255,255,255,0.3);
        box-shadow        : inset 0 -1px 1px rgba(255,255,255,0.3);

    }

    .meter > span {

        color:#fff;
        height: 100%;
        display: block;
        font-weight: bold;
        font-family: sans-serif;

        -webkit-border-top-right-radius: 20px;
        -webkit-border-bottom-right-radius: 20px;
        -moz-border-radius-topright: 20px;
        -moz-border-radius-bottomright: 20px;
        border-top-right-radius: 20px;
        border-bottom-right-radius: 20px;
        -webkit-border-top-left-radius: 20px;
        -webkit-border-bottom-left-radius: 20px;
        -moz-border-radius-topleft: 20px;
        -moz-border-radius-bottomleft: 20px;
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
        background-color: rgb(43,194,83);

        background-image: -webkit-gradient(
            linear,
            left bottom,
            left top,
            color-stop(0, rgb(43,194,83)),
            color-stop(1, rgb(84,240,84))
        );

        background-image: -moz-linear-gradient(
            center bottom,
            rgb(43,194,83) 37%,
            rgb(84,240,84) 69%
        );

        -webkit-box-shadow: 
            inset 0 2px 9px  rgba(255,255,255,0.3),
            inset 0 -2px 6px rgba(0,0,0,0.4);
        -moz-box-shadow: 
            inset 0 2px 9px  rgba(255,255,255,0.3),
            inset 0 -2px 6px rgba(0,0,0,0.4);
        box-shadow: 
            inset 0 2px 9px  rgba(255,255,255,0.3),
            inset 0 -2px 6px rgba(0,0,0,0.4);

        position: relative;
        overflow: hidden;
    }

    .meter > span:after, .animate > span > span {
        content: "";
        position: absolute;
        top: 0; left: 0; bottom: 0; right: 0;
        background-image: 
            -webkit-gradient(linear, 0 0, 100% 100%, 
                color-stop(.25, rgba(255, 255, 255, .2)), 
                color-stop(.25, transparent), color-stop(.5, transparent), 
                color-stop(.5, rgba(255, 255, 255, .2)), 
                color-stop(.75, rgba(255, 255, 255, .2)), 
                color-stop(.75, transparent), to(transparent)
            );
        background-image: 
            -moz-linear-gradient(
                -45deg, 
                rgba(255, 255, 255, .2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, .2) 50%, 
                rgba(255, 255, 255, .2) 75%, 
                transparent 75%, 
                transparent
            );
        z-index: 1;
        -webkit-background-size: 50px 50px;
        -moz-background-size: 50px 50px;
        -webkit-animation: move 2s linear infinite;
        -webkit-border-top-right-radius: 20px;
        -webkit-border-bottom-right-radius: 20px;
        -moz-border-radius-topright: 20px;
        -moz-border-radius-bottomright: 20px;
        border-top-right-radius: 20px;
        border-bottom-right-radius: 20px;
        -webkit-border-top-left-radius: 20px;
        -webkit-border-bottom-left-radius: 20px;
        -moz-border-radius-topleft: 20px;
        -moz-border-radius-bottomleft: 20px;
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
        overflow: hidden;
    }

    .animate > span:after {
        display: none;
    }

    @-webkit-keyframes move {
        0% {
            background-position: 0 0;
        }
        100% {
            background-position: 50px 50px;
        }
    }

    .orange > span {
        background-color: #f1a165;
        background-image: -moz-linear-gradient(top, #f1a165, #f36d0a);
        background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0, #f1a165),color-stop(1, #f36d0a));
        background-image: -webkit-linear-gradient(#f1a165, #f36d0a); 
    }

    .red > span {
        background-color: #f0a3a3;
        background-image: -moz-linear-gradient(top, #f0a3a3, #f42323);
        background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0, #f0a3a3),color-stop(1, #f42323));
        background-image: -webkit-linear-gradient(#f0a3a3, #f42323);
    }

    .nostripes > span > span, .nostripes > span:after {
        -webkit-animation: none;
        background-image: none;
    }

</style>


<script>

    function generateUUID(){
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
        .replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0;
            var v = c == 'x'?r:r&0x3|0x8;
            return v.toString(16);
        }).toLocaleUpperCase();
    };

    function jsonTexture(options) {

        var options = options || {}; // important!

        return {
            _id       : ObjectId(),
            uuid      : generateUUID(),
            name      : options.name  || "",
            type      : options.type  || 1009,
            flipY     : options.flipY || true,
            wrapS     : options.wrapS || 1001,
            wrapT     : options.wrapT || 1001,
            offset    : options.offset || [0, 0],
            repeat    : options.repeat || [1, 1],
            format    : options.format  || 1021,
            version   : options.version || 0,
            mapping   : options.mapping || 300,
            mipmaps   : options.mipmaps || [],
            minFilter : options.minFilter || 1008,
            magFilter : options.magFilter || 1006,
            encoding  : options.encoding  || 3000,
            anisotropy: options.anisotropy || 1,
            sourceFile: options.sourceFile || "",
            unpackAlignment : options.unpackAlignment  || 4,
            generateMipmaps : options.generateMipmaps  || true,
            premultiplyAlpha: options.premultiplyAlpha || false,
        };
    }

    function getTextureData(id){
    //  Returns a resolved promise with record data from imgur.com.
        debugMode && console.log(`GET https://api.imgur.com/3/image/${id}`);
        return new Promise(function( resolve, reject ){
            var xhttp = new XMLHttpRequest();
            var clientid = "60db267c697bb33";  // textures app.
            var endpoint = "https://api.imgur.com/3/image/" + id;
            xhttp.open("GET", endpoint, true);
            xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
            xhttp.onreadystatechange = function() {
                if (this.readyState === 4) {
                    var response = "";
                    if (this.status >= 200 && this.status < 300) {
                        response = JSON.parse(this.responseText);
                        debugMode && console.log(response.data);
                        resolve(response.data); // resolve promise.
                    } else {
                        var err = JSON.parse(this.responseText).data.error;
                        console.error( err.type, err );
                        throw err;
                    }
                }
            };

            xhttp.send();
            xhttp = null;
        });
    }

    function uploadTexture(file){
    //  Returns a resolved promise with record data from imgur.com.
        debugMode && console.log(`uploading ${file.name}...`);
        return new Promise(function( resolve, reject ){

            var formdata = new FormData();
            formdata.append("image", file);
            formdata.append("type",  file.type);
            formdata.append("name",  file.name);

            var xhttp = new XMLHttpRequest();
            var clientid = "60db267c697bb33";  // textures app.
            var endpoint = "https://api.imgur.com/3/image";
            xhttp.open("POST", endpoint, true);
            xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4) {
                    var response = "";
                    if (this.status >= 200 && this.status < 300) {
                        response = JSON.parse(this.responseText);
                        debugMode && console.log(response.data);
                        resolve(response.data); // resolve promise.
                    } else {
                        var err = JSON.parse(this.responseText).data.error;
                        console.error( err.type, err );
                        throw err;
                    }
                }
            };

            xhttp.send(formdata);
            xhttp = null;
        });
    }

</script>

<div class="helpers-header texture-header">
    <h2 style="margin-bottom:20px;">Texture:</h2>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select gender:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="texture-gender-droplist" class="form-control gender-droplist" readonly>
                <option value="">Select sex:</option>
                <option value="male">male</option>
                <option value="female">female</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const titleTextfield = $("input#material-title").get(0);
    const slotDroplist   = $("#texture-outfit-slot").get(0);
    const genderDroplist = $("#texture-gender-droplist").get(0);
    const texturePreview = $("img#texture-preview").get(0);
    const importedTextures = $("select#imported-textures").get(0);

    var Signal = signals.Signal;
    var genderDroplistChanged = new Signal();

    $(genderDroplist).on("change", function(){

        if ( !this.value ) {

        //  Overwrite gender value.
            this.value = viewer.contentWindow.localPlayer.outfit.getGender();

        //  Reset texture preview.
            // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".
        //  $(texturePreview).attr({src: "//:0"}); 

        }

    //  Null values NOT allowed.

        if ( !this.value ) return;

        genderDroplistChanged.dispatch( this.value );

    });

    genderDroplistChanged.add(function(value){

    //  Reset texture preview.
        // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".
    //  if ( !value )  $(texturePreview).attr({src: "//:0"}); 

    //  Null values NOT allowed.

        if ( !value ) return;

        var data = "/gender/" + value;
        viewer.contentWindow.localPlayerHandler(data);

        store( "Sex", data );

    });

    genderDroplistChanged.add(function(){

        if ( !slotDroplist.value ) return;
        if ( !genderDroplist.value ) return;
        if ( importedTextures.value ) return;

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

    //  Null outfit NOT allowed.
        if ( !viewer.contentWindow[gender][slot] ) return;

    //  This is the "THREE" of scene window that has UVsDebug().
        var THREE = viewer.contentWindow.THREE;  //  important!

        var geometry = viewer.contentWindow[gender][slot].geometry;
    //  texturePreview.src = THREE.UVsDebug(geometry, 512).toDataURL();

    //  Using window.URL.createObjectURL().
        THREE.UVsDebug(geometry, 512).toBlob(function(blob){
            texturePreview.src = window.URL.createObjectURL(blob);
        }, "image/jpeg");

    });

})();

</script>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select outfit slot:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="texture-outfit-slot" class="form-control outfit-slot-droplist" readonly>
                <option value="">Select slot:</option>
                <option value="body">body</option>
                <option value="eyes">eyes</option>
                <option value="hairs">hairs</option>
                <option value="stockings">stockings</option>
                <option value="underwears">underwears</option>
                <option value="costume">costume</option>
                <option value="tshirt">tshirt</option>
                <option value="trousers">trousers</option>
                <option value="dress">dress</option>
                <option value="shoes">shoes</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const slotDroplist   = $("#texture-outfit-slot").get(0);
    const genderDroplist = $("#texture-gender-droplist").get(0);
    const texturePreview = $("img#texture-preview").get(0);
    const importedTextures = $("select#imported-textures").get(0);

    var Signal = signals.Signal;
    var outfitSlotChanged = new Signal();

    $(slotDroplist).on("change", function(){

    //  Null value IS allowed!
        outfitSlotChanged.dispatch(this.value);

    });

    outfitSlotChanged.add(function(value){

    //  Null value IS allowed!

        var data = "/select/" + value;
        viewer.contentWindow.localPlayerHandler(data);

    });

    outfitSlotChanged.add(function(){

        if ( !genderDroplist.value ) {
            texturePreview.src = "//:0"; return;
        }

        if ( !slotDroplist.value ) {
            texturePreview.src = "//:0"; return;
        }

        if ( importedTextures.value ) {
            texturePreview.src = "//:0"; return;
        }

//  https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

    //  Null outfit NOT allowed.
        if ( !viewer.contentWindow[gender][slot] ) return;

    //  This is the "THREE" of scene window that has UVsDebug().
        var THREE = viewer.contentWindow.THREE;  //  important!

        var geometry = viewer.contentWindow[gender][slot].geometry;
    //  texturePreview.src = THREE.UVsDebug(geometry, 512).toDataURL();

    //  Using window.URL.createObjectURL().
        THREE.UVsDebug(geometry, 512).toBlob(function(blob){
            texturePreview.src = window.URL.createObjectURL(blob);
        }, "image/jpeg");

    });

})();

</script>

<div id="texture-items" class="well">

    <hr />

    <h4>Choose texture:
        <div id="counter" class="pull-right small" style="margin-top:4px;color:#ddd;">
            <span id="from">zero</span>
            to <span id="upto">zero</span>
            of <span id="count">none</span>
        </div>
    </h4>

    <div id="texture-pager" class="pager">

        <div style="margin:10px 0px 10px;height:35px;">
            <li class="btn btn-primary get-prev-btn pull-left">&#9668;</li>
            <div class="pager-buttons-holder" style="display:inline;">
                <a class="btn btn-default page-btn">1</a>
                <a class="btn btn-default page-btn">2</a>
                <a class="btn btn-default page-btn">3</a>
                <a class="btn btn-default page-btn">4</a>
            </div>
            <li class="btn btn-primary get-next-btn pull-right">&#9658;</li>
        </div>

        <div id="texture-viewer" style="text-align:center;margin-bottom:10px;border:1px solid;">
            <img id="texture-preview" style="max-width:100%;max-height:300px;margin:auto;">
        </div>

        <div style="height:45px;margin-bottom:10px;">
            <select id="imported-textures" class="form-control material-texture-droplist" readonly>
                <option value="">Import textures:</option>
            </select>
        </div>

        <div style="margin-bottom:20px;">
            <input id="texture-fileinput" type="file" class="hidden" multiple>
            <div id="clear-imported-textures" class="form-control btn btn-danger btn-white-outline gradient-btn pull-left" style="width:24%;">Clear</div>
            <div id="import-texture-button" class="form-control btn btn-primary btn-white-outline gradient-btn" style="width:24%;margin:0 1%;">Import</div>
            <div id="upload-selected-texture" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:24%;">Upload</div>
            <div id="delete-selected-texture" class="form-control btn btn-danger btn-white-outline gradient-btn pull-right" style="width:24%;">Delete</div>
        </div>

        <div id="documents-display" class="well" style="display:none;"></div>

        <div style="margin:10px 0px 10px;height:35px;">
            <li class="btn btn-primary btn-white-outline first-page-btn pull-left" style="margin-right:5px;">First</li>
            <li class="btn btn-primary btn-white-outline get-prev-group-btn pull-left">&#9668;&#9668;</li>
            <li class="btn btn-primary btn-white-outline last-page-btn pull-right" style="margin-left:5px;">Last</li>
            <li class="btn btn-primary btn-white-outline get-next-group-btn pull-right">&#9658;&#9658;</li>
        </div>

    </div>

</div>

<script>

(function(){

    const texturePreview = $("img#texture-preview").get(0);
    $(texturePreview).on("load", function(){
        window.URL.revokeObjectURL(this.src); // important!
        debugMode && console.log("revoked", this.src);
    });

})();

</script>

<script>

caches.open("textures").then(function(cache){

//  Pager.

    const maps = [
        "map", 
        "bumpMap", 
        "emissiveMap", 
        "metalnessMap", 
        "roughnessMap", 
        "displacementMap", 
        "alphaMap", 
        "normalMap", 
        "lightMap", 
    //  "envMap",
        "aoMap", 
    ];

    var json = {};

    var timeout;
    var interval;
    var delay = 200;
    var selectors = {};

    const limit = 1;

    var max = 0;
    var skip = 0;
    var lastpage = 0;
    var currentpage = 0;
    var currentindex = 0;

    const collection = db.collection("textures");
    debugMode && console.log({"collection":collection});

    const viewer = document.getElementById("viewer");
    const texturePreview = $("img#texture-preview").get(0);
    const outfitDroplist = $("#texture-outfit-slot").get(0);
    const genderDroplist = $("#texture-gender-droplist").get(0);
    const textureMapControls = $("#texture-map-controls").get(0);

    const texturesPanel  = document.getElementById("texture-items");
    const counter        = $(texturesPanel).find("#counter").get(0);

    const pager = document.getElementById("texture-pager");
    const pageSelector   = "#texture-pager .page-btn";
    const firstPageBtn   = $(pager).find(".first-page-btn").get(0);
    const lastPageBtn    = $(pager).find(".last-page-btn").get(0);
    const prevPageBtn    = $(pager).find(".get-prev-btn").get(0);
    const nextPageBtn    = $(pager).find(".get-next-btn").get(0);
    const prevGroupBtn   = $(pager).find(".get-prev-group-btn").get(0);
    const nextGroupBtn   = $(pager).find(".get-next-group-btn").get(0);
    const pagebuttons    = $(pager).find(".page-btn");
    const pageslength    = $(pager).find(".page-btn").length;
    const displayObjects = $(pager).find("#documents-display").get(0);

    const textureApplyBtn = $("#apply-texture-button").get(0);

//  Signals.

    var Signal = signals.Signal;
    var textureSelected = new Signal();
    var textureApplyBtnClicked = new Signal();

    textureSelected.add(function(id){

        collection.findOne({"_id":id}, function(err){
            if (err) throw err;
        }).then(function(doc){
            return doc.url;
        }).then(function(url){
            cache.match(url).then(function(response){
                return response.blob();
            }).then(function(blob){

                json.sourceFile = url; // important!
                texturePreview.src = window.URL.createObjectURL(blob);

            }).catch(function(err){
                console.error(err);
            });
        }).catch(function(err){
            console.error(err);
        });

    });

    function reset(){

        max = 0;
        skip = 0;
        lastpage = 0;
        currentpage = 0;
        currentindex = 0;

    }

    function init(){

    //  Page buttons numbering.
        pagebuttons.each(function(i){
            pagebuttons[i].skip = limit * i;
            $(pagebuttons[i]).text( i + 1 );
        });

    //  Current button setup.
        pagebuttons.removeClass("btn-primary");
        var currentButton = pagebuttons.get(0);
        $(currentButton).addClass("btn-primary");

    //  Clear listed objects.
        $(displayObjects).children().remove();

    }

    async function count(){
    //  too slow?
        var k = skip;
        await collection.find(selectors)
        .skip(skip).forEach(function(){
            ++k;  //  debugMode && console.log("k:", k);
        });
        return k;
    }

    function get_items(){

        $(displayObjects).children().remove();
        collection.find(selectors).skip(skip)
        .limit(limit).toArray(function(err){
            if (err) throw err;
        }).then(function(docs){

            $(displayObjects).children().remove();
            debugMode && console.log({"docs":docs});

            docs.forEach(function(json){
                var element = document.createElement("div");
                element.title = json.name;
                element.classList.add("texture-item");
                element.innerText = element.id = json._id; 
                $(element).on("click", function(){
                    clearTimeout(this.interval);
                    this.interval = setTimeout( function(){
                        $(".texture-item").removeClass("selected");
                        $(element).addClass("selected");
                        textureSelected.dispatch(element.id);
                    }, delay );
                });
                $(displayObjects).append( element );
            });

        }).catch(function(err){
            console.error(err);
        });

    }

    function pagerClicked(){

    //  Get last page.
        lastpage = parseInt( max / limit );

    //  Get current page.
        currentpage = parseInt( skip / limit );

    //  Get current index.
        currentindex = parseInt( currentpage % pageslength );

    //  Page buttons numbering.
        var num = parseInt( currentpage / pageslength ) * pageslength;

        pagebuttons.each(function(i){
            var page = num + i;
            pagebuttons[i].skip = limit * page; // important!
            $(pagebuttons[i]).text( page + 1 ); // important!
        });

    //  Current button setup.
        pagebuttons.removeClass("btn-primary");
        var currentButton = pagebuttons.get( currentindex );
        $(currentButton).addClass("btn-primary");

    //  Display info.

        if ( max == 0 )
            $(counter).find("#from").text("-"); 
        else if ( skip == max )
            $(counter).find("#from").text(skip);
        else
            $(counter).find("#from").text(skip + 1);

        if ( max == 0 )
            $(counter).find("#upto").text("-");
        else if ( skip + limit > max )
            $(counter).find("#upto").text( max );
        else
            $(counter).find("#upto").text(skip + limit);

        $(counter).find("#count").text(max);

        debugMode && console.log({"max":max, "skip":skip, "index": currentindex});

        if ( max && skip < max ) {
            clearTimeout(interval);
            interval = setTimeout( function getItem(){

                $(displayObjects).children().remove();
                collection.find().skip(skip).limit(1)
                .toArray(function(err, docs){
                    if (err) throw err;
                    return docs[0];
                }).then( function(doc){

                    json.sourceFile = doc.url; // important!
                    return doc.url;

                //  Optional.
                    var element = document.createElement("div");
                    element.title = doc.name;
                    element.classList.add("texture-item");
                    element.innerText = element.id = doc._id;
                    $(displayObjects).append( element );
                    $(element).on("click", function(){
                        clearTimeout(this.interval);
                        this.interval = setTimeout( function(){
                            $(".texture-item").removeClass("selected");
                            $(element).addClass("selected");
                            textureSelected.dispatch(element.id);
                        }, delay );
                    });

                }).then( async function(url){
                    return await cache.match(url)
                    .then(function(response){
                        return response.blob();
                    });

                }).then(function(blob){
                    texturePreview.src = window.URL.createObjectURL(blob);

                }).catch(function(err){
                    console.error(err);
                });

            }, 500 );

        }

    }

    $(textureApplyBtn).on("click", function(){
        textureApplyBtnClicked.dispatch();
    });

    textureApplyBtnClicked.add(function(){

        var data = {};
        data.maps    = [];
        data.slot    = outfitDroplist.value;
        data.gender  = genderDroplist.value;
        data.texture = json;

        $(textureMapControls).find("input[type=checkbox]")
        .toArray().forEach(function(item){
            if (item.checked) {
                data.maps.push(item.id);
                item.checked = false;
            }
        });

        debugMode && console.log({"data":data});
        viewer.contentWindow.localPlayerTextureHandler(data);

    });

//  For performance we count items only when we ask last page 
//  or we change droplist selectors. Not need to count on backward.

//  Page button.

    $(pageSelector).on("click", function(){

        if ( max && this.skip < max ) {
            skip = this.skip;
            pagerClicked();
        }

    });

//  First page.

    $(firstPageBtn).on("click", function(){

        skip = 0;
        pagerClicked();

    });

//  Last page.

    $(lastPageBtn).on("click", function(){

        if ( max && max > 0 ) {

            var lastpage = parseInt(max / limit);

            if ( limit * lastpage < max ) {

                skip = limit * lastpage;          //  limit * parseInt(max / limit);

            } else {

                skip = limit * ( lastpage - 1 );  //  limit * ( parseInt(max / limit) - 1 );

            }

        } else {

            skip = 0;

        }

        pagerClicked();

    });

//  Prev page.

    $(prevPageBtn).on("click", function(){

        if ( skip - limit < 0 ) {

            skip = 0;

        } else {

            skip -= limit;
        }

        pagerClicked();

    });

//  Next page.

    $(nextPageBtn).on("click", function(){

        var lastpage = parseInt(max / limit);

        if ( skip + limit < max )

            skip += limit;

        else if ( skip + limit > max )
            
            skip = limit * lastpage;

    //  else if ( skip + limit == max ) skip;

        pagerClicked();

    });

//  Prev group.

    $(prevGroupBtn).on("click", function(){

        var offset = pageslength * limit;

        if ( skip - offset < 0 ) {

            skip = 0;

        } else {

            skip -= offset;
        }

        pagerClicked();

    });

//  Next group.

    $(nextGroupBtn).on("click", function(){

        var offset = pageslength * limit;

        if ( max > 0 ) {

            var lastpage = parseInt(max / limit);

            if ( skip + offset < max ) {

                skip += offset;

            } else if ( skip + offset > max ) {

                if ( limit * lastpage < max ) {

                    skip = limit * lastpage;

                } else {

                    skip = limit * ( lastpage - 1 );
                }

            } else if ( skip + offset == max ) {

                skip = limit * ( lastpage - 1 );

            }

        } else {

            skip = 0;

        }

        pagerClicked();

    });

    count().then(function(k){
        max = k; 
        return max;
    }).then(function(max){
        pagerClicked();
    });

});

</script>


<div id="texture-map-controls" class="well" style="background:none;border-radius:8px;height:auto;">

    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">Map:</span>
        <input type="checkbox" id="map" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">BumpMap:</span>
        <input type="checkbox" id="bumpMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">EmissiveMap:</span>
        <input type="checkbox" id="emissiveMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">MetalnessMap:</span>
        <input type="checkbox" id="metalnessMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">RoughnessMap:</span>
        <input type="checkbox" id="roughnessMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">DisplacementMap:</span>
        <input type="checkbox" id="displacementMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">AOMap:</span>
        <input type="checkbox" id="aoMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">AlphaMap:</span>
        <input type="checkbox" id="alphaMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">LightMap:</span>
        <input type="checkbox" id="lightMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">NormalMap:</span>
        <input type="checkbox" id="normalMap" class="form-control pull-right texture-checkbox texture-checkbox-control">
    </h4>

</div>

<script>

(function(){

    const textureHeaderSelector = ".texture-header";
    const helpersHeaderSelector = ".helpers-header";
    const textureControlSelector = "#texture-map-controls";

    var Signal = signals.Signal;
    var dblclicked = new Signal();

//  Event handlers.
    function onDoubleClickEventHandler( element ){
        if ( $(element).css("display") == "none" ) {
            $(element).slideDown();
        } else {
            $(element).slideUp();
        }
    }

//  Event listeners.
    dblclicked.add(onDoubleClickEventHandler);

//  Dispatch events.
    $(textureHeaderSelector).on("dblclick", function(){
        dblclicked.dispatch( $(textureControlSelector).get(0) );
    });

})();

</script>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select property:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="texture-property" class="form-control texture-property-droplist" readonly>
                <option value="">Select key:</option>
                <option value="_id">_id</option>
                <option value="uuid">uuid</option>
                <option value="name">name</option>
                <option value="flipY">flipY</option>
                <option value="offset">offset</option>
                <option value="repeat">repeat</option>
                <option value="version">version</option>
                <option value="generateMipmaps">generate</option>
                <option value="premultiplyAlpha">premultiply</option>
                <!-- ----------------------------------------------- -->
                <option value="type" style="display:none;">type</option>
                <option value="wrapS" style="display:none;">wrapS</option>
                <option value="wrapT" style="display:none;">wrapT</option>
                <option value="unpackAlignment" style="display:none;">unpack</option>
                <option value="anisotropy" style="display:none;">anisotropy</option>
                <option value="encoding" style="display:none;">encoding</option>
                <option value="format" style="display:none;">format</option>
                <option value="magFilter" style="display:none;">magFilter</option>
                <option value="mapping" style="display:none;">mapping</option>
                <option value="minFilter" style="display:none;">minFilter</option>
                <option value="mipmaps" style="display:none;">mipmaps</option>
                <option value="sourceFile" style="display:none;">sourceFile</option>
            </select>
        </div>
    </h4>
</div>

<div id="texture-property-controls" class="well"></div>

<hr/>

<div style="margin-bottom:10px;">
    <div id="new-texture-button" class="form-control btn btn-primary btn-white-outline gradient-btn pull-left" style="width:24%;">New</div>
    <div id="copy-texture-button" class="form-control btn btn-primary btn-white-outline gradient-btn" style="width:24%;margin-left:1%;">Copy</div>
    <div id="apply-texture-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:24%;">Apply</div>
    <div id="save-texture-button" class="form-control btn btn-success btn-white-outline gradient-btn pull-right" style="width:24%;">Save</div>
</div>

<script>

(function(){

/*
//  const VERSION = 5;
    const NAME = "USER";

    var db = new zango.Db( NAME, {
        current:    true,
        settings:   true,
        animations: true,
        outfits:    true,
        materials:  true,
        textures:   true,
        products:   true,
    });

    db.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`Database ${db.name} (v${db.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });
*/

    const viewer = document.getElementById("viewer");
    const propDroplist = $("select#texture-property").get(0);
    const propControls = $("#texture-property-controls").get(0);
    const importedTextures = $("select#imported-textures").get(0);

    function generateUUID(){
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
        .replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0;
            var v = c == 'x'?r:r&0x3|0x8;
            return v.toString(16);
        }).toLocaleUpperCase();
    };

    function jsonTexture(options) {

        var options = options || {}; // important!

        return {
            _id       : ObjectId(),
            uuid      : generateUUID(),
            name      : options.name  || "",
            type      : options.type  || 1009,
            flipY     : options.flipY || true,
            wrapS     : options.wrapS || 1001,
            wrapT     : options.wrapT || 1001,
            offset    : options.offset || [0, 0],
            repeat    : options.repeat || [1, 1],
            format    : options.format  || 1021,
            version   : options.version || 0,
            mapping   : options.mapping || 300,
            mipmaps   : options.mipmaps || [],
            minFilter : options.minFilter || 1008,
            magFilter : options.magFilter || 1006,
            encoding  : options.encoding  || 3000,
            anisotropy: options.anisotropy || 1,
            sourceFile: options.sourceFile || "",
            unpackAlignment : options.unpackAlignment  || 4,
            generateMipmaps : options.generateMipmaps  || true,
            premultiplyAlpha: options.premultiplyAlpha || false,
        };
    }

    var json = {}; // new jsonTexture();

    debugMode && console.log({"json texture":json});

    var Signal = signals.Signal;
    var propertiesDroplistChanged = new Signal();

    function propertyDroplistReset(){

        $(propDroplist).children().remove();
        $(propControls).children().remove();

        var option = document.createElement("option");
        option.value = ""; option.innerText = "Select key:";
        $(propDroplist).append(option);

        json = new jsonTexture();

    //  Sort json keys.
        var sortedKeys = Object.keys(json).sort();
        for ( var i = 0; i < sortedKeys.length; i++ ) {

            var key = sortedKeys[i];
            var option = document.createElement("option");

            option.value = key; 
            option.innerText = key;

            $(propDroplist).append(option);

        }

    }

    $(propDroplist).on("change", function(){
        propertiesDroplistChanged.dispatch(this.value);
    });

    propertiesDroplistChanged.add(function (){
        $(propControls).css({height:""});
        $(propControls).children().remove();
    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "anisotropy" ) return;

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.classList.add("form-control", "pull-right", "texture-input-number");
        input.id = `texture-input_${key}`; input.type = "number"; input.step = 0.1;

        input.value = json[key];

        $(input).on("input", function(){
            json[key] = round(this.value, 2);
        });

        $(input).on("change", function(){
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "encoding" ) return;
    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "flipY" ) return;

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `texture-input_${key}`; input.type = "checkbox"; 
        input.classList.add("form-control", "pull-right", "texture-checkbox");

        input.checked = json[key] || "";

        $(input).on("click", function(){
            json[key] = this.checked;
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "format" ) return;
    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "generateMipmaps" ) return;

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `texture-input_${key}`; input.type = "checkbox"; 
        input.classList.add("form-control", "pull-right", "texture-checkbox");

        input.checked = json[key] || "";

        $(input).on("click", function(){
            json[key] = this.checked;
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "magFilter" ) return;
    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "mapping" ) return;
    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "minFilter" ) return;
    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "mipmaps" ) return;
    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "name" ) return;

        var span = document.createElement("span");
        span.innerText = "name"; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `texture-input_${key}`; input.type = "text";
        input.classList.add("form-control", "pull-right", "texture-textfield");

        input.value = json[key]; // name.

        $(input).on("input", function(){
            json[key] = this.value;
        });

        $(input).on("change", function(){
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "premultiplyAlpha" ) return;

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `texture-input_${key}`; input.type = "checkbox"; 
        input.classList.add("form-control", "pull-right", "texture-checkbox");

        input.checked = json[key] || "";

        $(input).on("click", function(){
            json[key] = this.checked;
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "offset" ) return;

        var span = document.createElement("span");
    //  span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var divX = document.createElement("div"); 
        divX.innerText = "x:"; divX.style.cssText = "display:inline;"; 
        var inputx = document.createElement("input"); 
        inputx.id = `texture-input_${key}-x`; inputx.type = "number"; inputx.step = 0.01;
        inputx.classList.add("form-control", "texture-input-number");
        inputx.style.cssText = "display:inline;"; $(divX).append(inputx);

        var divY = document.createElement("div"); 
        divY.innerText = "y:"; divY.style.cssText = "display:inline;float:right;";
        var inputy = document.createElement("input"); 
        inputy.id = `texture-input_${key}-y`; inputy.type = "number"; inputy.step = 0.01;
        inputy.classList.add("form-control", "texture-input-number");
        inputy.style.cssText = "display:inline;";  $(divY).append(inputy);

        if ( json[key] && Array.isArray(json[key]) ) {
            inputx.value = json[key][0];
            inputy.value = json[key][1];
        }

        $(inputx).on("input", function(){
            json[key][0] = round(this.value, 2);
        });

        $(inputy).on("input", function(){
            json[key][1] = round(this.value, 2);
        });

        $(inputx).on("change", function(){
            debugMode && console.log({[key]:json[key]});
        });

        $(inputy).on("change", function(){
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, divX, divY);

    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "repeat" ) return;

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `texture-input_${key}`; input.type = "number"; input.step = 1;
        input.classList.add("form-control", "pull-right", "texture-input-number");

        if ( json[key] && Array.isArray(json[key]) ) {
            input.value = json[key][0];
        }

        $(input).on("input", function(){
            json[key][0] = json[key][1] = parseInt(this.value);
        });

        $(input).on("change", function(){
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "sourceFile" ) return;
    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "type" ) return;
    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "unpackAlignment" ) return;
    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "uuid" ) return;

        var button = document.createElement("div");
        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
        button.id = "texture-button_uuid"; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

        var input = document.createElement("input");
        input.id = `texture-input_${key}`; input.type = "text"; input.readOnly = true;
        input.classList.add("form-control", "pull-right", "uuid-texture-textfield");

        input.value = json[key]; // generateUUID();

        $(button).on("click", function(){
            input.value = json[key] = generateUUID();
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(button, input);

    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "version" ) return;

        var span = document.createElement("span");
        span.innerText = "version"; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `texture-input_${key}`; 
        input.type = "number"; input.min = 1; input.step = 1;
        input.classList.add("form-control", "pull-right", "texture-input-number");

        input.value = json[key];

        $(input).on("input", function(){
            json[key] = parseInt(this.value);
        });

        $(input).on("change", function(){
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "wrapS" ) return;
    });

    propertiesDroplistChanged.add(function (key){
        if ( !key || key != "wrapT" ) return;
    });

    propertiesDroplistChanged.add(function (key){

        if ( !key || key != "_id" ) return;

        var button = document.createElement("div");
        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
        button.id = "texture-button_id"; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

        var input = document.createElement("input");
        input.id = "texture-input_id"; input.type = "text"; input.readOnly = true;
        input.classList.add("form-control", "text-center", "pull-right", "uuid-texture-textfield");

        input.value = json[key]; // ObjectId();

        $(button).on("click", function(){
            input.value = json[key] = ObjectId();
            debugMode && console.log({[key]:json[key]});
        });

        $(propControls).slideDown();
        $(propControls).append(button, input);

    });


    const noscr = "//:0";  // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".

    var files = {};
    var uploads = [];
    var textures = {};

    const slotDroplist     = $("#texture-outfit-slot").get(0);
    const genderDroplist   = $("#texture-gender-droplist").get(0);
    const texturePreview   = $("img#texture-preview").get(0);
    const textureControls  = $("#texture-map-controls").get(0);
    const textureDroplist  = $("select#imported-textures").get(0);
    const textureNewButton = $("#new-texture-button").get(0);
    const textureImportBtn = $("#import-texture-button").get(0);
    const textureFileinput = $("input#texture-fileinput").get(0);
    const textureUploadBtn = $("#upload-selected-texture").get(0);
    const textureDeleteBtn = $("#delete-selected-texture").get(0);
    const texturesClearBtn = $("#clear-imported-textures").get(0);
    const textureUploadButton = $("#upload-selected-texture").get(0);

    const textureControlSelector = "#texture-map-controls";
    const textureCheckboxSelector = "input[type=checkbox].material-texture-checkbox";
    const texturePropertyControls = document.getElementById("texture-property-controls");

    var textureDroplistChanged = new Signal();

    textureDroplistChanged.add(function(value){

        if ( value ) {

        //  Using window.URL.createObjectURL().
            texturePreview.src = window.URL.createObjectURL( files[ value ] );

            return;
        } 
        
        if ( !value ) {

            var slot = slotDroplist.value;
            var gender = viewer.contentWindow.localPlayer.outfit.getGender();

            if ( !gender || !slot || !viewer.contentWindow[gender][slot] ) {
            //  reset texture preview image src and return.
                // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".
                texturePreview.src = "//:0";  return;  // nosrc.  
            }

        //  This is the "THREE" of scene window that has UVsDebug().
            var THREE = viewer.contentWindow.THREE;  //  important!
            var geometry = viewer.contentWindow[gender][slot].geometry;

        //  Using window.URL.createObjectURL().
            THREE.UVsDebug(geometry, 512).toBlob(function(blob){
                texturePreview.src = window.URL.createObjectURL(blob);
            }, "image/jpeg");

            return;

        }

    });

//  BUTTON NEW.

    $(textureNewButton).on("click", function(){

    //  Reset texture map checkboxes.
        $(textureCheckboxSelector).attr({checked:false});

        clearTimeout(this.interval);
        this.interval = setTimeout(function(){
            json = {}; // new jsonTexture();
            debugMode && console.log({"new":json});
        }, 200);
    });

//  BUTTON IMPORT.

    $(textureImportBtn).on("click", function(){
        $(textureFileinput).val("");
        $(textureFileinput).click();
    });

    $(textureFileinput).on("change", function(){

        if ( this.files.length == 0 ) return;

        $(textureCheckboxSelector).attr({checked:false});
        $(textureDroplist).find(`option[value=""]`).remove();

    //  Using window.URL.createObjectURL().

        for (var i = 0; i < this.files.length; i++ ) {

            var file = textureFileinput.files[i];
            var name = textureFileinput.files[i].name;

            files[ name ] = file;

        //  textures[ name ] = new jsonTexture();
        //  textures[ name ].name = name;
        //  textures[ name ].sourceFile = files[ name ]; // file;

            var option = document.createElement("option");
        //  option.id = textures[ name ]._id;
            option.value = option.innerText = name;

            $(textureDroplist).append(option);
            textureDroplist.value = option.value;
            textureDroplistChanged.dispatch(option.value);  // == $(textureDroplist).change();

        }

        debugMode && console.log({"files": files, "textures": textures});

    });

//  SELECT TEXTURE DROPLIST.

    $(textureDroplist).on("change", function(){

    //  Reset texture map checkboxes.
        $(textureCheckboxSelector).attr({checked:false});

    //  Overwrite gender droplist value.
        genderDroplist.value = viewer.contentWindow.localPlayer.outfit.getGender();

        if ( !this.value ) {
            $(textureControlSelector).slideUp();
        } else {
            $(textureControlSelector).slideDown();
        }

        textureDroplistChanged.dispatch(this.value);

    });


//  BUTTON DELETE.
    var deleteButtonClicked = new Signal();

    $(textureDeleteBtn).on("click", function(){
        clearTimeout(this.interval);
        this.interval = setTimeout( function(){
            deleteButtonClicked.dispatch();
        }, 200 );
    });

    deleteButtonClicked.add( function(){
    //  This signal function first. important!

        if ( !textureDroplist.value ) {
            debugMode && console.log("files:", files);
            return;
        }

        if ( !textureDroplist.selectedOptions.length ) {
            debugMode && console.log("files:", files);
            return;
        }

    //  Optional.

        var name = textureDroplist.value;
        debugMode && console.log("delete from files:", name);

        delete files[ name ];
        delete textures[ name ];

        debugMode && console.log("files:", files);
    //  debugMode && console.log("textures:", textures);

    });

    deleteButtonClicked.add( function(){
    //  This signal function last. important!

        var option = textureDroplist.selectedOptions[0];

        if ( !option ) return;
        if ( !option.value ) return;

        $(option).remove();

        if (textureDroplist.options.length == 0) {
            var option = document.createElement("option");
            option.value = "";  option.innerText = "Import textures:";
            $(textureDroplist).append(option);
        }

        $(textureControlSelector).slideUp();
        $(textureCheckboxSelector).attr({checked:false});
        textureDroplistChanged.dispatch( textureDroplist.value );  // == $(textureDroplist).change();

    });

//  BUTTON CLEAR.

    $(texturesClearBtn).on("click", function(){

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){
        //  debugMode && console.log({"files":files, "textures": textures});

            $(textureDroplist).children().remove();

            if (textureDroplist.options.length == 0) {
                var option = document.createElement("option");
                option.value = "";  option.innerText = "Import textures:";
                $(textureDroplist).append(option);
            }

            $(textureControlSelector).slideUp();
            $(textureCheckboxSelector).attr({checked:false});
            textureDroplistChanged.dispatch( textureDroplist.value );  // == $(textureDroplist).change();

        //  Optional.

            for (var name in files){
                delete files[name];
                delete textures[name];
            }

        //  files = {}; textures = {};

            debugMode && console.log("files:", files);
        //  debugMode && console.log("textures:", textures);

        }, 250 );

    });


//  BUTTON UPLOAD.

    $(textureUploadButton).on("click", uploadSelectedTexture );

    function errorDialogOptions(err){
        return {
            size: "small",
            className: "middle",
            closeButton: false,
            title: `<div class="alert-icon icon-warning">` 
            + `</div><h2 style="margin:auto;">Error!</h2>`,
            message: `<div>Sorry! An error occurred.</div><div>${err}</div>`,
            buttons: {
                cancel: {
                    label: "Close",
                    className: "btn-default",
                },
            },
        };
    }

    function uploadSelectedTexture(){

        if ( !navigator.onLine ) {
            var err = "Your connection to the internet is down.";
            debugMode && console.error(err);
            return bootbox.dialog( errorDialogOptions(err) );
        }

        if ( !importedTextures.value ) {
            var err = "There isn&#39;t selected texture to upload.";
            debugMode && console.error(err);
            return bootbox.dialog( errorDialogOptions(err) );
        }

    //  Using files.

        if ( !files[ textureDroplist.value ] ) return;

        var file = files[ textureDroplist.value ];
        var $option = $( textureDroplist.selectedOptions[0] );

        var dialog = bootbox.dialog({
            message: `<div class="text-center meter">`
            + `<span style="width:100%;">Uploading...`
            + `</span></div>`,
            buttons: false,
            closeButton: false,
            className: "middle",
        });

        new Promise(function(resolve, reject){

            $(textureUploadButton).off(); // important!
            debugMode && console.log(`uploading ${file.name}...`);

            var formdata = new FormData();
            formdata.append("image", file);
            formdata.append("type",  file.type);
            formdata.append("name",  file.name);
            formdata.append("title", file.name);

            var xhttp = new XMLHttpRequest();
            var clientid = "60db267c697bb33";  // textures app Client-ID.
            var endpoint = "https://api.imgur.com/3/image";
            xhttp.open("POST", endpoint, true);
            xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4) {
                    var response = "";
                    if (this.status >= 200 && this.status < 300) {
                        response = JSON.parse(this.responseText);
                        resolve( response ); // resolve promise.
                    } else {
                        var err = JSON.parse(this.responseText).data.error;
                        console.error( err.type, err );
                        throw err;
                    }
                }
            };

            xhttp.send(formdata);
            xhttp = null;

        }).then( function( response ){

            var data = response.data;
            debugMode && console.log({"data": data});

        //  Add to cache.
            caches.open("textures").then(function(cache){

                cache.add(data.link);
                debugMode && console.log( data.link );

            });

            return data;

        }).then( function(data){

        //  Add to collection.

            var entry = {};

            entry._id = data.id;
            entry.url = data.link;
            entry.size = data.size;
            entry.type = data.type;
            entry.name = data.name || data.title;
            entry.width = data.width;
            entry.height = data.height;
            entry.datetime = data.datetime;
            entry.deletehash = data.deletehash;
            entry.endpoint = "https://api.imgur.com/3/image/" + data.id;
            entry.clientID = "60db267c697bb33";  // textures app Client-ID.

            var collection = db.collection("textures");
            collection.insert(entry, function(err){
                if (err) throw err;
            }).catch(function(err){
                console.error(err);
            });

        }).then( function(){

        //  Success.

            $(textureCheckboxSelector).attr({checked:false});
            debugMode && console.log(`deleting "${file.name}" from files.`);

            delete files[ file.name ];
        //  delete textures[ file.name ];

            debugMode && console.log( "removing", $option.get(0) );

            $option.remove();

            if (textureDroplist.options.length == 0) {
                var option = document.createElement("option");
                option.value = "";  option.innerText = "Import textures:";
                $(textureDroplist).append(option);
            }

            textureDroplistChanged.dispatch( textureDroplist.value );

            var msg = `Texture ${file.name} uploaded successfully!`;
            bootbox.dialog({
                size: "small",
                className: "middle",
                closeButton: false,
                title: `<div class="alert-icon icon-success">`
                + `</div><h2 style="margin:auto;">Success</h2>`,
                message: `<div>${msg}</div>`,
                buttons: {
                    success: {
                        label: "Close",
                        className: "btn-success",
                        callback: function(){
                            bootbox.hideAll();
                        },
                    },
                },
            });

        }).catch(function(err){

            bootbox.hideAll();
            console.error(err);
            bootbox.dialog( errorDialogOptions(err) );

        }).then(function(){

            dialog.modal("hide"); // important!
        //  Enable upload button. // important!
            $(textureUploadButton).on("click", uploadSelectedTexture );
            debugMode && console.log( "Upload button is enabled and ready to upload." );

        });

    }

    const maps = [
        "map", 
        "bumpMap", 
        "emissiveMap", 
        "metalnessMap", 
        "roughnessMap", 
        "displacementMap", 
        "alphaMap", 
        "normalMap", 
        "lightMap", 
    //  "envMap",
        "aoMap", 
    ];

//  const textureControls  = $("#texture-map-controls").get(0);

    var propertyValueChanged = new Signal();
    propertyValueChanged.add(function(key, value){
        debugMode && console.log({"json":json});
    });

    maps.forEach(function( key ){
        $(textureControls).find(`input#${key}`).on("click", function(){

            if (!textureDroplist.value) return;

            var name = textureDroplist.value;

            if ( !this.checked ) {

                var texture = null;
                delete json[ key ];

            } else {

                var texture = textures[ name ];  //  json texture.
                json[ key ] = textures[ name ];

            }

            propertyValueChanged.dispatch( key, texture );

        });
    });






//  deepCopy.js

    function deepCopy(obj) {
        if (Object.prototype.toString.call(obj) === "[object Array]") {
            var out = [], i = 0, len = obj.length;
            for ( ; i < len; i++ ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        if (typeof obj === "object") {
            var out = {}, i;
            for ( i in obj ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        return obj;
    }

//  round.js  source: "https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round"

    function round(number, precision) {
        var shift = function (number, precision, reverseShift) {
            if (reverseShift) {
                precision = -precision;
            }  
            numArray = ("" + number).split("e");
            return +(numArray[0] + "e" + (numArray[1] ? (+numArray[1] + precision) : precision));
        };
        return shift(Math.round(shift(number, precision, false)), precision, true);
    }

})();

</script>

<script>

(function(){

/*
//  const VERSION = 5;
    const NAME = "USER";

    var db = new zango.Db( NAME, {
        current:    true,
        settings:   true,
        animations: true,
        outfits:    true,
        materials:  true,
        textures:   true,
        products:   true,
    });

    db.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`Database ${db.name} (v${db.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });
*/

/*
    var json;
    var files = {};
    var uploads = [];
    var textures = {};

    const viewer = document.getElementById("viewer");
    const slotDroplist     = $("#texture-outfit-slot").get(0);
    const genderDroplist   = $("#texture-gender-droplist").get(0);
    const textureControls  = $("#texture-map-controls").get(0);
    const textureImportBtn = $("#import-texture-button").get(0);
    const textureFileinput = $("input#texture-fileinput").get(0);
    const textureDeleteBtn = $("#delete-selected-texture").get(0);
    const texturesClearBtn = $("#clear-imported-textures").get(0);
    const textureNewButton = $("#new-texture-button").get(0);
    const textureUploadBtn = $("#upload-selected-texture").get(0);
    const textureDroplist  = $("select#imported-textures").get(0);
    const texturePreviewImg = $("img#texture-preview").get(0);

//  const THREE = viewer.contentWindow.THREE;

    const textureControlSelector = "#texture-map-controls";
    const textureCheckboxSelector = "input[type=checkbox].material-texture-checkbox";
    const texturePropertyControls = document.getElementById("texture-property-controls");

    var Signal = signals.Signal;
    var textureDroplistChanged = new Signal();

    function generateUUID(){
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
        .replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0;
            var v = c == 'x'?r:r&0x3|0x8;
            return v.toString(16);
        }).toLocaleUpperCase();
    }

    function jsonTexture(options) {

        var options = options || {};

        return {
            _id       : ObjectId(),
            uuid      : generateUUID(),
            name      : options.name  || "",
            type      : options.type  || 1009,
            flipY     : options.flipY || true,
            wrapS     : options.wrapS || 1001,
            wrapT     : options.wrapT || 1001,
            offset    : options.offset || [0, 0],
            repeat    : options.repeat || [1, 1],
            format    : options.format  || 1021,
            version   : options.version || 0,
            mapping   : options.mapping || 300,
            mipmaps   : options.mipmaps || [],
            minFilter : options.minFilter || 1008,
            magFilter : options.magFilter || 1006,
            encoding  : options.encoding  || 3000,
            anisotropy: options.anisotropy || 1,
            sourceFile: options.sourceFile || "",
            unpackAlignment : options.unpackAlignment  || 4,
            generateMipmaps : options.generateMipmaps  || true,
            premultiplyAlpha: options.premultiplyAlpha || false,
        };

    }

    const maps = [
        "map", 
        "bumpMap", 
        "emissiveMap", 
        "metalnessMap", 
        "roughnessMap", 
        "displacementMap", 
        "alphaMap", 
        "normalMap", 
        "lightMap", 
    //  "envMap",
        "aoMap", 
    ];

    maps.forEach(function( key ){
        $(textureControls).find(`input#${key}`).on("click", function(){

            if (!textureDroplist.value) return;

            var name = textureDroplist.value;

            if ( !this.checked ) {

                var texture = null;
                delete json[ key ];

            } else {

                var texture = textures[ name ];  //  json texture.
                json[ key ] = textures[ name ];

            }

            propertyValueChanged.dispatch( key, texture );

        });
    });
*/

/*
//  BUTTON IMPORT.

    $(textureImportBtn).on("click", function(){
        $(textureFileinput).val("");
        $(textureFileinput).click();
    });

    $(textureFileinput).on("change", function(){
        if ( this.files.length == 0 ) return;

        $(textureDroplist).children().remove();
        $(textureCheckboxSelector).attr({checked:false});

    //  Using FileReader().

        for (var i = 0; i < this.files.length; i++ ) {

            (function(){

                var file = textureFileinput.files[i];
                var name = textureFileinput.files[i].name;

                if ( name in files && file.lastModified == files[name].lastModified 
                    && file.size == files[name].size && file.type == files[name].type ) {

                        // (WHATEVER) //

                } else {

                    files[ name ] = file;

                    var reader = new FileReader();
                    reader.onload = function() {

                        textures[ name ] = new jsonTexture();
                        textures[ name ].sourceFile = reader.result;
                        textures[ name ].name = name;

                        var option = document.createElement("option");
                        option.value = option.innerText = name;
                        //  option.id = textures[ name ]._id;

                        $(textureDroplist).append(option);
                        textureDroplist.value = option.value;
                        $(textureDroplist).change();

                    };

                    reader.readAsDataURL(files[ name ]);

                }

            })();

        }

        debugMode && console.log({
            "files": files, 
            "textures": textures,
        });

    });

*/

/*
//  SELECT TEXTURE DROPLIST.

    $(textureDroplist).on("change", function(){
        textureDroplistChanged.dispatch(this.value);
    });

    textureDroplistChanged.add(function(value){

        if ( value ) {

        //  Using dataURL from FileReader.
            var src = textures[ value ].sourceFile;
            $(texturePreviewImg).attr({"src":src});

        } else {

            var slot = slotDroplist.value;

        //  Overwrite gender droplist value.
            var gender = genderDroplist.value = viewer.contentWindow.localPlayer.outfit.getGender();

        //  Reset texture preview.
        // "https://stackoverflow.com/questions/5775469/whats-the-valid-way-to-include-an-image-with-no-src".
        //  if ( !viewer.contentWindow[gender][slot] ) {
        //      $(texturePreviewImg).attr({src: "//:0"});  return;
        //  }

            var THREE = viewer.contentWindow.THREE; // important!
            var geometry = viewer.contentWindow[gender][slot].geometry;
            texturePreviewImg.src = THREE.UVsDebug(geometry, 512).toDataURL();

        }

    });

    textureDroplistChanged.add(function(value){

        $(textureCheckboxSelector).attr({checked:false});

        if ( !value ) {
            $(textureControlSelector).slideUp();
        } else {
            $(textureControlSelector).slideDown();
        }

    });

*/

/*
//  BUTTON DELETE.

    $(textureDeleteBtn).on("click", function(){

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){

            var option = textureDroplist.selectedOptions[0];

            if ( !option ) return;
            if ( !option.value ) return;

            $(option).remove();

            if (textureDroplist.options.length == 0) {
                var option = document.createElement("option");
                option.value = "";  option.innerText = "Import textures:";
                $(textureDroplist).append(option);
            }

            $(textureControlSelector).slideUp();
            $(textureCheckboxSelector).attr({checked:false});
            textureDroplistChanged.dispatch( textureDroplist.value );  // == $(textureDroplist).change();

        //  Optional.

            delete files[ option.value ];
            delete textures[ option.value ];
            debugMode && console.log({"files":files, "textures": textures});

        }, 200 );

    });


//  BUTTON CLEAR.

    $(texturesClearBtn).on("click", function(){

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){
            debugMode && console.log({"files":files, "textures": textures});

            $(textureDroplist).children().remove();

            if (textureDroplist.options.length == 0) {
                var option = document.createElement("option");
                option.value = "";  option.innerText = "Import textures:";
                $(textureDroplist).append(option);
            }

            $(textureControlSelector).slideUp();
            $(textureCheckboxSelector).attr({checked:false});
            textureDroplistChanged.dispatch( textureDroplist.value );  // == $(textureDroplist).change();

        //  Optional.

            for (var name in textures){
                delete files[name];
                delete textures[name];
            }

            files = {}; textures = {};

        }, 250 );

    });

*/

/*
//  BUTTON UPLOAD.
    $(textureUploadBtn).on("click", function(){
        debugMode && console.log({"uploads":uploads});

        if ( !uploads.length ) {
            var msg = "There is nothing to upload.";
            return bootbox.dialog({
                size: "small",
                className: "middle",
                closeButton: false,
                title: `<div class="alert-icon icon-warning"></div>`
                     + `<h2 style="margin:auto;">Sorry!</h2>`,
                message: `<div>${msg}</div>`,
                buttons: {
                    cancel: {
                        label: "Close",
                        className: "btn-default",
                        callback: function(){
                            debugMode && console.log(msg);
                        },
                    },
                },
            });
        }

        if ( !navigator.onLine ) {
            var msg = "Your connection to the internet is down.";
            return bootbox.dialog({
                size: "small",
                className: "middle",
                closeButton: false,
                title: `<div class="alert-icon icon-error"></div>`
                     + `<h2 style="margin:auto;">Sorry!</h2>`,
                message: `<div>${msg}</div>`,
                buttons: {
                    cancel: {
                        label: "Close",
                        className: "btn-default",
                        callback: function(){
                            debugMode && console.log(msg);
                        },
                    },
                },
            });
        }

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){

            while( uploads.length ){
                uploads.shift().call();
            }

        }, 250 );

    });

//  BUTTON NEW.

    $(textureNewButton).on("click", function(){
        clearTimeout(this.interval);
        this.interval = setTimeout(function(){
            json = new jsonTexture();
            debugMode && console.log({"new":json});
        }, 200);
    });

*/

/*
//  deepCopy.js

    function deepCopy(obj) {
        if (Object.prototype.toString.call(obj) === "[object Array]") {
            var out = [], i = 0, len = obj.length;
            for ( ; i < len; i++ ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        if (typeof obj === "object") {
            var out = {}, i;
            for ( i in obj ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        return obj;
    }

//  round.js  source: "https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round"

    function round(number, precision) {
        var shift = function (number, precision, reverseShift) {
            if (reverseShift) {
                precision = -precision;
            }  
            numArray = ("" + number).split("e");
            return +(numArray[0] + "e" + (numArray[1] ? (+numArray[1] + precision) : precision));
        };
        return shift(Math.round(shift(number, precision, false)), precision, true);
    }

*/

})();

/*
    function jsonTexture() {
        return {
            anisotropy: 1,
            encoding: 3000,
            flipY: true,
            format: 1021,
            generateMipmaps: true,
            magFilter: 1006,
            mapping: 300,
            minFilter: 1008,
            mipmaps: [],
            name: "",
            offset: [0, 0],
            premultiplyAlpha: false,
            repeat: [1, 1],
            sourceFile: "",
            type: 1009,
            unpackAlignment: 4,
            uuid: generateUUID(),
            version: 0,
            wrapS: 1001,
            wrapT: 1001,
            _id: ObjectId(),
        };
    };
*/

</script>


<script>
/*
(function(){

    const viewer = document.getElementById("viewer");
    const texturePreview = $("img#texture-preview").get(0);
    const importedTextures = $("select#imported-textures").get(0);
    const textureUploadButton = $("#upload-selected-texture").get(0);

    $(textureUploadButton).one("click", uploadSelectedTexture );

    function uploadSelectedTexture(){

        if ( !navigator.onLine ) {
            var err = "Your connection to the internet is down.";
            debugMode && console.error(err);
            return bootbox.dialog( errorDialogOptions(err) );
        }

        if ( !importedTextures.value ) {
            var err = "There is not selected texture to upload.";
            debugMode && console.error(err);
            return bootbox.dialog( errorDialogOptions(err) );
        }

        var name = importedTextures.selectedOptions[0].value;
        var data = texturePreview.src.split(";base64,").pop(); // important!
        var type = texturePreview.src.split(";base64,").shift().replace("data:", "");

    //  Using files.

        var file = files[ importedTextures.value ];

        new Promise(function(resolve, reject){
            debugMode && console.log(`uploading ${name}...`);

            var formdata = new FormData();
            formdata.append("image", file);
            formdata.append("type",  file.type);
            formdata.append("name",  file.name);
        //  formdata.append("title", file.name);

            var xhttp = new XMLHttpRequest();
            var clientid = "60db267c697bb33";  // textures.
            var endpoint = "https://api.imgur.com/3/image";
            xhttp.open("POST", endpoint, true);
            xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4) {
                    var response = "";
                    if (this.status >= 200 && this.status < 300) {
                        response = JSON.parse(this.responseText);
                        resolve( response ); // resolve promise.
                    } else {
                        var err = JSON.parse(this.responseText).data.error;
                        console.error( err.type, err );
                        throw err;
                    }
                }
            };

            xhttp.send(formdata);
            xhttp = null;

        }).then( function( response ){

            var data = response.data;
            debugMode && console.log({"data": data});

        //  Add to cache.
            caches.open("textures").then(function(cache){

                cache.add(data.link);

            //  Success.
                var msg = `Texture ${name} uploaded successfully!`;
                bootbox.dialog({
                    size: "small",
                    className: "middle",
                    title: `<div class="alert-icon icon-success">`
                    + `</div><h2 style="margin:auto;">Success</h2>`,
                    message: `<div>${msg}</div>`,
                    buttons: {
                        success: {
                            label: "Close",
                            className: "btn-success",
                            callback: function(){
                                $(option).remove();
                                $(importedTextures).change();
                            }
                        },
                    },
                });

            });

        }).catch(function(err){
            console.error(err);
            bootbox.dialog( errorDialogOptions(err) );
        }).then(function(){
            $(textureUploadButton).one("click", uploadSelectedTexture );
        });

        function errorDialogOptions(err){
            return {
                size: "small",
                className: "middle",
                title: `<div class="alert-icon icon-warning">` 
                + `</div><h2 style="margin:auto;">Error!</h2>`,
                message: `<div>Sorry! An error occurred.</div><div>${err}</div>`,
                buttons: {
                    cancel: {
                        label: "Close",
                        className: "btn-default",
                    },
                },
            };
        }

    }

})();

*/
</script>
